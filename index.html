<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ç”¨æˆ¶åˆ†ç¾¤å»£å‘Šç™¼é€ç³»çµ±</title>

  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* header */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 1000;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 18px;
      background: #111827; /* æ·±è‰² */
      color: #fff;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }

    .brand{
      font-weight: 700;
      letter-spacing: .3px;
    }

    .topbar-nav{
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .nav-item{
      position: relative;
      color: rgba(255,255,255,0.85);
      text-decoration: none;
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      user-select: none;
    }

    .nav-item:hover{
      background: rgba(255,255,255,0.08);
      color: #fff;
    }

    .nav-item.active{
      background: rgba(37,99,235,0.25);
      color: #fff;
      border: 1px solid rgba(37,99,235,0.45);
    }

    .has-dropdown:hover .dropdown{
      display: block;
    }

    .dropdown{
      display: none;
      position: absolute;
      top: 44px;
      left: 0;
      min-width: 180px;
      background: #0b1220;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 28px rgba(0,0,0,0.35);
    }

    .dropdown-item{
      display: block;
      padding: 10px 12px;
      color: rgba(255,255,255,0.9);
      text-decoration: none;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }

    .dropdown-item:last-child{
      border-bottom: none;
    }

    .dropdown-item:hover{
      background: rgba(255,255,255,0.08);
    }

    .topbar-right{
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .pill{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.10);
      color: rgba(255,255,255,0.9);
    }
    /* body */
    body {
      margin: 0;
      font-family: "Segoe UI", "Noto Sans TC", sans-serif;
      background: #f4f6f9;
    }

    .container {
      display: flex;
      height: calc(100vh - 64px); /* æ‰£æ‰ topbar é«˜åº¦ */
    }

    /* å·¦å´åˆ†ç¾¤ */
    .sidebar {
      width: 260px;
      background: #1f2937;
      color: #fff;
      padding: 20px;
      padding-top: 0px;

      /* âœ… æ–°å¢ */
      height: calc(100vh - 64px); /* æ‰£æ‰ topbar */
      overflow-y: auto;
    }
    .sidebar-hidden {
      display: none;
    }
    .cluster {
      padding: 10px 12px;
      margin-bottom: 8px;
      background: #374151;
      border-radius: 8px;
      cursor: pointer;
    }

    .cluster.active {
      background: #2563eb;
    }

    /* å³å´ */
    .content {
      flex: 1;
      padding: 30px;
      padding-top: 0px;
    }

    .content-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .send-btn {
      background: #ef4444;
      color: #fff;
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      margin: 10px;
    }

    table {
      width: 100%;
      background: #fff;
      border-collapse: collapse;
      border-radius: 12px;
      overflow: hidden;
    }

    th, td {
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
      text-align: center;
    }

    th {
      background: #f9fafb;
    }

    /* ===== Modal ===== */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 999;
    }

    .modal-content {
      background: #fff;
      width: 420px;
      padding: 20px;
      border-radius: 12px;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .modal-content label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
    }

    .modal-content textarea {
      width: 100%;
      height: 100px;
      margin-top: 6px;
      padding: 8px;
    }

    .modal-actions {
      margin-top: 20px;
      text-align: right;
    }

    .cancel-btn {
      background: #9ca3af;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      margin-right: 10px;
      cursor: pointer;
    }
    .empty-hint {
      background: #ffffff;
      border: 2px dashed #cbd5e1;
      color: #6b7280;
      text-align: center;
      padding: 60px 20px;
      border-radius: 12px;
      font-size: 18px;
      margin-top: 40px;
    }
    #userTableWrapper {
      display: none;
    }
    .table-scroll {
      max-height: calc(100vh - 64px - 200px);
      overflow-y: auto;
      border-radius: 12px;
    }
    .algo-toggle{
      display:flex;
      gap:8px;
      margin: 14px 0 12px;
    }

    .algo-btn{
      flex:1;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.12);
      background:#111827;
      color: rgba(255,255,255,0.9);
      cursor:pointer;
    }

    .algo-btn.active{
      background:#2563eb;
      border-color: rgba(37,99,235,0.55);
      color:#fff;
    }
  </style>
</head>
<body>
<header class="topbar">
  <div class="topbar-left">
    <div class="brand">ğŸ“£ ç”¨æˆ¶æ´å¯Ÿèˆ‡æŠ•æ”¾å¾Œå°</div>
  </div>

  <nav class="topbar-nav">
    <a class="nav-item active" href="#" data-page="seg">å®¢ç¾¤åˆ†ç¾¤ä¸­å¿ƒ</a>

    <a class="nav-item" data-page="buy">äº¤æ˜“è¡Œç‚ºæ´å¯Ÿ</a>

    <a class="nav-item" data-page="view">ç€è¦½è¡Œç‚ºæ´å¯Ÿ</a>

    <a class="nav-item" href="#" data-page="bundle">å•†å“çµ„åˆå„ªåŒ–</a>
  </nav>
</header>
<div class="container">
  <div class="sidebar">

    <!-- åˆ†ç¾¤ä¸­å¿ƒ sidebar -->
    <div id="sidebar-seg">
      <h2>ğŸ“Š ç”¨æˆ¶åˆ†ç¾¤</h2>
      <div id="clusterList"></div>
    </div>

    <!-- æ´å¯Ÿ sidebarï¼ˆäº¤æ˜“/ç€è¦½ç”¨ï¼‰ -->
    <div id="sidebar-insight" style="display:none;">
      <div class="algo-toggle">
        <button id="btnKmeans" class="algo-btn active" type="button">KMEANS</button>
        <button id="btnDbscan" class="algo-btn" type="button">DBSCAN</button>
      </div>

      <div id="clusterList_kmeans"></div>
      <div id="clusterList_dbscan" style="display:none;"></div>
    </div>

  </div>


  <div class="content">
    <!-- ç”¨æˆ¶åˆ†ç¾¤ -->
    <div class="page" id="page-seg">
      <div class="content-header">
        <h2 id="clusterTitle">ç”¨æˆ¶åˆ†ç¾¤</h2>
        <button class="send-btn" onclick="openAdModal()">ğŸ“¢ ç™¼é€å»£å‘Š</button>
      </div>
      <!-- åˆå§‹æç¤º -->
      <div id="emptyHint" class="empty-hint">
        ğŸ‘ˆ è«‹æ–¼å·¦å´é¸æ“‡æ¬²æŸ¥çœ‹ç”¨æˆ¶
      </div>
      <div class="table-scroll">
        <table id="userTableWrapper">
          <thead>
            <tr>
              <th>User ID</th>
              <th>Name</th>
            </tr>
          </thead>
          <tbody id="userTable"></tbody>
        </table>
      </div>
    </div>

    <!-- âœ… å…±ç”¨æ´å¯Ÿé ï¼ˆè²·/çœ‹éƒ½ç”¨é€™ä¸€é ï¼‰ -->
    <div class="page" id="page-insight" style="display:none">
      <div class="content-header">
        <h2 id="insightPageTitle">æ´å¯Ÿ</h2>
        <button class="send-btn" onclick="openAdModal()">ğŸ“¢ ç™¼é€å»£å‘Š</button>
      </div>

      <div id="emptyHint-insight" class="empty-hint">
        ğŸ‘ˆ è«‹æ–¼å·¦å´é¸æ“‡æ¬²æŸ¥çœ‹æ—ç¾¤ï¼ˆé¡¯ç¤ºé›·é”åœ–ï¼‰
      </div>

      <div id="insightSummary" class="card" style="display:none;">
        <h2 id="insightTitle">Cluster</h2>

        <div class="stats">
          <div>å®¢æˆ¶æ•¸ï¼š<b id="stat_customer_count"></b> äºº</div>
          <div>å¹³å‡æ¶ˆè²»é‡‘é¡ï¼šç´„ <b id="stat_avg_amount"></b> å…ƒ</div>
          <div>æµå¤±æ¯”ä¾‹ï¼š<b id="stat_churn_pct"></b></div>
        </div>

        <div style="height: 320px; margin-top: 12px;">
          <canvas id="insightRadar"></canvas>
        </div>
      </div>
    </div>

    <!-- å•†å“çµ„åˆå„ªåŒ– -->
    <div class="page" id="page-bundle" style="display:none">
      <div class="content-header" style="align-items:center;">
        <h2>å•†å“çµ„åˆå„ªåŒ–</h2>
        <div class="pill" id="bundleMeta" style="display:none;">å…± <b id="bundleCount"></b> çµ„</div>
      </div>

      <div id="bundleHint" class="empty-hint">
        ğŸ“¦ ä¾ã€Œä¿¡å¿ƒåº¦ã€æ’åºé¡¯ç¤º
      </div>
      <div class="table-scroll" id="bundleTableWrapper" style="display:none;">
        <table>
          <thead>
            <tr>
              <th>ç†±éŠ·çµ„åˆ</th>
              <th>å‰é … (è²·äº† A)</th>
              <th>å¾Œé … (è·Ÿè‘—è²· B)</th>
              <th>ä¿¡å¿ƒåº¦</th>
              <th>æå‡åº¦ (Lift)</th>
              <th>ç¢ºä¿¡åº¦</th>
            </tr>
          </thead>
          <tbody id="bundleTableBody"></tbody>
        </table>
      </div>
      <div class="metric-explain" style="margin:16px 0; line-height:1.8;">
        <p><b>æ”¯æŒåº¦ (Support)</b>ï¼šé€™çµ„å•†å“çµ„åˆåœ¨æ‰€æœ‰è¨‚å–®ä¸­å‡ºç¾çš„æ¯”ä¾‹ï¼Œç”¨ä¾†åˆ¤æ–·è©²çµ„åˆæ˜¯å¦å¤ æ™®éã€‚<br/>
        <b>ä¿¡å¿ƒåº¦ (Confidence)</b>ï¼šè²·äº† A çš„äººç•¶ä¸­ï¼Œæœ‰å¤šå°‘æ¯”ä¾‹ä¹Ÿæœƒè²· Bï¼Œç”¨ä¾†é æ¸¬æ¨è–¦ A â†’ B çš„æˆåŠŸæ©Ÿç‡ã€‚<br/>
        <b>æå‡åº¦ (Lift)</b>ï¼šè²· A ä¹‹å¾Œè²· B çš„æ©Ÿç‡ï¼Œæ˜¯ä¸€èˆ¬äººè²· B çš„å¹¾å€ï¼Œæ•¸å€¼å¤§æ–¼ 1 ä»£è¡¨ A å° B å…·æœ‰æ˜é¡¯æ¨å‹•æ•ˆæœï¼Œæ˜¯æœ€æ ¸å¿ƒçš„åˆ¤æ–·æŒ‡æ¨™ã€‚<br/>
        <b>ç¢ºä¿¡åº¦ (Conviction)</b>ï¼šè¡¡é‡å•†å“é—œè¯æ˜¯å¦ç©©å®šã€æ˜¯å¦åƒå·§åˆï¼Œæ•¸å€¼è¶Šé«˜ä»£è¡¨ A å° B çš„ä¾è³´æ€§è¶Šå¼·ã€‚</p>
      </div>
    </div>
  </div>
</div>

<!-- ===== å»£å‘Šè¦–çª— ===== -->
<div id="adModal" class="modal">
  <div class="modal-content">
    <h2>ğŸ“¢ ç™¼é€å»£å‘Š</h2>

    <label>å»£å‘Šåœ–ç‰‡</label>
    <input type="file" id="adImage" accept="image/*">

    <label>å»£å‘Šæ–‡å­—</label>
    <textarea id="adText" placeholder="è«‹è¼¸å…¥å»£å‘Šå…§å®¹..."></textarea>

    <div class="modal-actions">
      <button class="cancel-btn" onclick="closeAdModal()">å–æ¶ˆ</button>
      <button class="send-btn" onclick="confirmSendAd()">ç¢ºèªç™¼é€</button>
    </div>
  </div>
</div>

<script>
  const summarySourceByPage = {
    buy: {
      kmeans: "kmeans_rfm_summary.json",
      dbscan: "dbscan_summary.json"
    },
    view: {
      kmeans: "kmeans_rfm_summary_interect.json",
      dbscan: "dbscan_summary_interect.json"
    }
  };
  let workbookData = {};
  let selectedInsight = null; 
  let currentCluster = "";
  let currentAlgo = "kmeans"; // "kmeans" | "dbscan"
  function setSidebarMode(mode){ // "seg" | "insight"
    const seg = document.getElementById("sidebar-seg");
    const insight = document.getElementById("sidebar-insight");

    if(mode === "seg"){
      seg.style.display = "block";
      insight.style.display = "none";
    }else{
      seg.style.display = "none";
      insight.style.display = "block";
      // é€²æ´å¯Ÿé æ™‚ï¼Œç¢ºä¿é¡¯ç¤ºæ­£ç¢º algo list
      setAlgo(currentAlgo);
    }
  }
  function loadInsightDataByPage(page) {
    const src = summarySourceByPage[page];
    if (!src) return;
    loadKmeansSummaryJson(src.kmeans);
    loadDbscanSummaryJson(src.dbscan);
  }
  function setAlgo(algo){
    currentAlgo = algo;

    // æŒ‰éˆ• active
    document.getElementById("btnKmeans").classList.toggle("active", algo === "kmeans");
    document.getElementById("btnDbscan").classList.toggle("active", algo === "dbscan");

    // åˆ—è¡¨é¡¯ç¤ºåˆ‡æ›
    document.getElementById("clusterList_kmeans").style.display = (algo === "kmeans") ? "block" : "none";
    document.getElementById("clusterList_dbscan").style.display = (algo === "dbscan") ? "block" : "none";
    const card = document.getElementById("insightSummary");
    if (card) card.style.display = "none";
    const hint = document.getElementById("emptyHint-insight");
    if (hint) hint.style.display = "block";
    selectedInsight = null;
  }
  document.getElementById("btnKmeans").addEventListener("click", () => setAlgo("kmeans"));
  document.getElementById("btnDbscan").addEventListener("click", () => setAlgo("dbscan"));
  let currentInsightPage = "buy"; // buy | view

  function switchPage(pageKey) {
    // âœ… å·¦å´ sidebar é¡¯ç¤ºæ§åˆ¶
    const sidebar = document.querySelector(".sidebar");

    if (pageKey === "bundle") {
      sidebar.classList.add("sidebar-hidden");   // å•†å“çµ„åˆé ï¼šéš±è—å·¦å´
    } else {
      sidebar.classList.remove("sidebar-hidden"); // å…¶ä»–é ï¼šé¡¯ç¤ºå·¦å´
    }

    // === åŸæœ¬çš„åˆ‡é é‚è¼¯ ===
    document.querySelectorAll(".page").forEach(p => p.style.display = "none");

    // âœ… buy/view éƒ½é€²å…±ç”¨æ´å¯Ÿé 
    if (pageKey === "buy" || pageKey === "view") {
      currentInsightPage = pageKey;
      document.getElementById("page-insight").style.display = "block";
      document.getElementById("insightPageTitle").textContent =
        (pageKey === "buy") ? "äº¤æ˜“è¡Œç‚ºæ´å¯Ÿ" : "ç€è¦½è¡Œç‚ºæ´å¯Ÿ";
      return;
    }

    // âœ… å•†å“çµ„åˆå„ªåŒ–
    if (pageKey === "bundle") {
      document.getElementById("page-bundle").style.display = "block";
      loadBundleXlsxOnce();
      return;
    }

    // å…¶ä»–é ç…§èˆŠ
    const target = document.getElementById(`page-${pageKey}`);
    if (target) target.style.display = "block";
  }
  
  fetch("lca_clustered_users_new.xlsx")
    .then(res => res.arrayBuffer())
    .then(data => {
      const workbook = XLSX.read(data, { type: "array" });
      workbook.SheetNames.forEach(name => {
        workbookData[name] = XLSX.utils.sheet_to_json(workbook.Sheets[name]);
      });
      renderClusterList();
    });

  document.querySelectorAll(".dropdown-item").forEach(sub => {
    sub.addEventListener("click", (e) => {
      e.preventDefault();

      const key = sub.dataset.sub;
      const page = key.split("-")[0]; // buy / view

      switchPage(page);

      console.log("åˆ‡æ›å­é åŠŸèƒ½ï¼š", key);
    });
  });
  function renderClusterList() {
    const list = document.getElementById("clusterList");
    list.innerHTML = "";
    Object.keys(workbookData).forEach(cluster => {
      const div = document.createElement("div");
      div.className = "cluster";
      div.innerText = cluster;
      div.onclick = () => selectCluster(cluster, div);
      list.appendChild(div);
    });
  }

  function selectCluster(name, el) {
    document.querySelectorAll("#clusterList .cluster").forEach(c => c.classList.remove("active"));
    el.classList.add("active");
    currentCluster = name;
    document.getElementById("clusterTitle").innerText = name;

    document.getElementById("emptyHint").style.display = "none";
    document.getElementById("userTableWrapper").style.display = "table";
    
    const tbody = document.getElementById("userTable");
    tbody.innerHTML = "";
    workbookData[name].forEach(u => {
      tbody.innerHTML += `<tr><td>${u.user_id}</td><td>${u.name}</td></tr>`;
    });
  }
  function updateInsightPanel(titleText, row) {
    document.getElementById("emptyHint-insight").style.display = "none";
    document.getElementById("insightSummary").style.display = "block";

    document.getElementById("insightTitle").textContent = titleText;
    document.getElementById("stat_customer_count").textContent = row.customer_count ?? "â€”";
    document.getElementById("stat_avg_amount").textContent = formatNumber(row.avg_total_purchase_amount, 4);
    document.getElementById("stat_churn_pct").textContent =
      `${formatNumber(row.churn_percentage, 4)}%`;

    renderInsightRadar(row);
  }
  
  /* ===== å»£å‘Šé‚è¼¯ ===== */

  async function openAdModal() {
    const page = getCurrentPageKey(); // ä½ åŸæœ¬å°±æœ‰

    // 1) åˆ†ç¾¤ä¸­å¿ƒï¼šè¦å…ˆé¸ Excel çš„ currentCluster
    if (page === "seg") {
      if (!currentCluster) {
        alert("è«‹å…ˆé¸æ“‡åˆ†ç¾¤");
        return;
      }
    }

    // 2) æ´å¯Ÿé ï¼šè¦å…ˆé¸ KMeans/DBSCAN çš„ selectedInsight
    if (page === "buy" || page === "view" || page === "insight") {
      if (!selectedInsight) {
        alert("è«‹å…ˆåœ¨å·¦å´é¸æ“‡ä¸€å€‹ KMEANS/DBSCAN åˆ†ç¾¤");
        return;
      }
    }

    // âœ… å…ˆçµ¦ä¸€æ®µã€Œé è¨­æ–‡å­—ã€
    const adTextEl = document.getElementById("adText");
    adTextEl.value = "æ­£åœ¨ç‚ºä½ ç”Ÿæˆå»£å‘Šæ–‡æ¡ˆâ€¦";

    // âœ… é–‹ modal
    document.getElementById("adModal").style.display = "block";

    // âœ… å†ç”¨ GPT ç”Ÿæˆä¸¦è¦†è“‹ textarea
    try {
      const payload = buildAdGenPayload(page);
      const res = await fetch("/api/adcopy", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      adTextEl.value = data.copy || "ï¼ˆç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼‰";
    } catch (err) {
      console.error("generate ad copy failed:", err);
      adTextEl.value = "ï¼ˆç”Ÿæˆå¤±æ•—ï¼šè«‹ç¢ºèªå¾Œç«¯ /api/adcopy æœ‰å•Ÿå‹•ï¼Œæˆ–æŸ¥çœ‹ Consoleï¼‰";
    }
  }

  function buildAdGenPayload(page){
    // ä¾ä½ ç›®å‰éœ€æ±‚ï¼šæ´å¯Ÿé è¦å¸¶ algo/clusterï¼›åˆ†ç¾¤ä¸­å¿ƒå¸¶ currentCluster
    if (page === "seg") {
      return {
        page,
        mode: "seg",
        cluster_label: currentCluster
      };
    }

    // æ´å¯Ÿé ï¼ˆbuy/view/insightï¼‰
    return {
      page,
      mode: "insight",
      insight: selectedInsight, // { algo, key, label, page... }
      // ä½ ä¹Ÿå¯ä»¥åŠ æ›´å¤šæ¬„ä½ï¼šç”¢å“/æ´»å‹•/å„ªæƒ /èªæ°£â€¦
      tone: "å°ˆæ¥­ä½†è¦ªåˆ‡",
      length: "80-120å­—",
      cta: "ç«‹å³æŸ¥çœ‹ / ç«‹å³é ˜å–"
    };
  }

  function closeAdModal() {
    document.getElementById("adModal").style.display = "none";
  }

  function confirmSendAd() {
    const page = getCurrentPageKey();
    const text = document.getElementById("adText").value;
    const image = document.getElementById("adImage").files[0];

    let targetLabel = "";
    let users = [];

    if (page === "seg") {
      targetLabel = currentCluster;
      users = workbookData[currentCluster] || [];
    } else if (page === "insight") {
      if (!selectedInsight) {
        alert("è«‹å…ˆé¸æ“‡æ´å¯Ÿåˆ†ç¾¤");
        return;
      }
      targetLabel = selectedInsight.label;
      // âš ï¸ æ´å¯Ÿåˆ†ç¾¤çš„ä½¿ç”¨è€…åå–®ä½ ç›®å‰æ²’æœ‰è³‡æ–™å°æ‡‰ï¼Œå…ˆç•™ç©ºæˆ–ä¹‹å¾Œå†ä¸²
      users = [];
    } else {
      alert("æ­¤é é¢ä¸æ”¯æ´æŠ•æ”¾");
      return;
    }

    console.log("ğŸ“¢ ç™¼é€å»£å‘Š");
    console.log("æŠ•æ”¾å°è±¡ï¼š", targetLabel);
    console.log("æ–‡å­—ï¼š", text);
    console.log("åœ–ç‰‡ï¼š", image);
    console.log("ç”¨æˆ¶ï¼š", users);

    alert(`å·²å°ã€Œ${targetLabel}ã€ç™¼é€å»£å‘Šï¼ˆæ¨¡æ“¬ï¼‰`);
    closeAdModal();
  }

  function resetInsightUI() {
    document.querySelectorAll("#clusterList_kmeans .cluster, #clusterList_dbscan .cluster")
      .forEach(c => c.classList.remove("active"));

    document.getElementById("insightSummary").style.display = "none";
    document.getElementById("emptyHint-insight").style.display = "block";
    selectedInsight = null;
  }

  document.querySelectorAll(".nav-item[data-page]").forEach(item => {
    item.addEventListener("click", () => {
      const page = item.dataset.page;
      switchPage(page);

      if (page === "buy" || page === "view") {
        setSidebarMode("insight");
        resetInsightUI();
        loadInsightDataByPage(page); // âœ… é€™è¡Œç¾åœ¨æœƒæ­£å¸¸è·‘
      } else {
        setSidebarMode("seg");
      }

      document.querySelectorAll(".nav-item").forEach(i => i.classList.remove("active"));
      item.classList.add("active");
    });
  });

  document.querySelectorAll(".dropdown-item").forEach(sub => {
    sub.addEventListener("click", (e) => {
      e.preventDefault();
      const key = sub.dataset.sub; // buy-rfm / view-churn ...
      console.log("åˆ‡æ›å­é ï¼š", key);
    });
  });
  let insightRadarChart = null;
  let kmeansDataByCluster = {};  // { "0": rowObj, "1": rowObj, ... }

  async function loadKmeansSummaryJson(url = "kmeans_rfm_summary.json") {
    const text = await fetch(url).then(r => r.text());
    const safeText = text.replace(/\bNaN\b/g, "null"); 
    const arr = JSON.parse(safeText);

    // å»ºç«‹ç´¢å¼•ï¼škey = KMeans_cluster_RFM
    kmeansDataByCluster = {};
    arr.forEach(row => {
      const k = row.KMeans_cluster_RFM;
      kmeansDataByCluster[String(k)] = row;
    });

    renderKmeansClusterList();
  }
  function renderKmeansClusterList() {
    const container = document.getElementById("clusterList_kmeans");
    if (!container) return;

    container.innerHTML = "";

    // ä¾ cluster id æ’åº
    const keys = Object.keys(kmeansDataByCluster).sort((a,b)=>Number(a)-Number(b));

    keys.forEach(k => {
      const div = document.createElement("div");
      div.className = "cluster"; // ç”¨ä½ åŸæœ¬ cluster æ¨£å¼
      div.textContent = `${k}`;
      div.onclick = () => selectKmeansCluster(k, div);
      container.appendChild(div);
    });
  }
  function roundTo(n, digits) {
  if (n === null || n === undefined || Number.isNaN(n)) return null;
  const m = Math.pow(10, digits);
  return Math.round(n * m) / m;
}

function formatNumber(n, digits = null) {
  if (n === null || n === undefined) return "â€”";
  if (digits === null) return String(n);
  return roundTo(Number(n), digits).toFixed(digits);
}

function selectKmeansCluster(clusterId, el) {
  document.querySelectorAll("#clusterList_kmeans .cluster").forEach(c => c.classList.remove("active"));
  if (el) el.classList.add("active");

  const row = kmeansDataByCluster[String(clusterId)];
  if (!row) return;
  selectedInsight = {
    page: getCurrentPageKey(),        // ä½ ä¸‹é¢æœƒåŠ é€™å€‹å‡½å¼
    algo: "kmeans",
    key: String(clusterId),
    label: `KMeans Cluster ${clusterId}`
  };
  updateInsightPanel(`KMeansï½œ ${clusterId}`, row);
}

function renderInsightRadar(row) {
  const ctx = document.getElementById("insightRadar");
  if (!ctx) return;

  const labels = ["R", "F", "M", "CAI"];
  const values = [row.avg_R_score ?? 0, row.avg_F_score ?? 0, row.avg_M_score ?? 0, row.avg_CAI_5 ?? 0];

  if (insightRadarChart) {
    insightRadarChart.data.labels = labels;
    insightRadarChart.data.datasets[0].data = values;
    insightRadarChart.update();
    return;
  }

  insightRadarChart = new Chart(ctx, {
    type: "radar",
    data: { labels, datasets: [{ label: "Avg Scores", data: values }] },
    options: { responsive: true, maintainAspectRatio: false, scales: { r: { beginAtZero: true } } }
  });
}
function renderKmeansRadar(row) {
  const ctx = document.getElementById("kmeansRadar");
  if (!ctx) return;

  const labels = ["R", "F", "M", "CAI"];
  const values = [
    row.avg_R_score ?? 0,
    row.avg_F_score ?? 0,
    row.avg_M_score ?? 0,
    row.avg_CAI_5 ?? 0
  ];

  if (insightRadarChart) {
    insightRadarChart.data.datasets[0].data = values;
    insightRadarChart.update();
    return;
  }

  insightRadarChart = new Chart(ctx, {
    type: "radar",
    data: {
      labels,
      datasets: [{
        label: "Avg Scores",
        data: values
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        r: {
          beginAtZero: true
        }
      }
    }
  });
}

let dbscanDataByCluster = {};  // { "æ ¸å¿ƒé«˜åƒ¹å€¼æ´»èºå®¢ç¾¤": rowObj, ... }

async function loadDbscanSummaryJson(url = "dbscan_summary.json") {
  const text = await fetch(url).then(r => r.text());
  const safeText = text.replace(/\bNaN\b/g, "null");
  const arr = JSON.parse(safeText);

  dbscanDataByCluster = {};
  arr.forEach(row => {
    const k = row.DBSCAN_cluster;            // âœ… é€™è£¡æ˜¯ä¸­æ–‡åç¨±
    dbscanDataByCluster[String(k)] = row;
  });

  renderDbscanClusterList();
}
function renderDbscanClusterList() {
  const container = document.getElementById("clusterList_dbscan");
  if (!container) return;

  container.innerHTML = "";

  // DBSCAN çš„ key æ˜¯ä¸­æ–‡å­—ä¸²ï¼Œç›´æ¥æ’åºå³å¯ï¼ˆå¯é¸ï¼‰
  const keys = Object.keys(dbscanDataByCluster).sort();

  keys.forEach(k => {
    const div = document.createElement("div");
    div.className = "cluster";
    div.textContent = k; // âœ… é¡¯ç¤ºã€Œæ ¸å¿ƒé«˜åƒ¹å€¼æ´»èºå®¢ç¾¤ã€ç­‰
    div.onclick = () => selectDbscanCluster(k, div);
    container.appendChild(div);
  });
}
function selectDbscanCluster(clusterName, el) {
  document.querySelectorAll("#clusterList_dbscan .cluster").forEach(c => c.classList.remove("active"));
  if (el) el.classList.add("active");

  const row = dbscanDataByCluster[String(clusterName)];
  if (!row) return;
  selectedInsight = {
    page: getCurrentPageKey(),
    algo: "dbscan",
    key: String(clusterName),
    label: `DBSCANï½œ${clusterName}`
  };
  updateInsightPanel(`DBSCANï½œ${clusterName}`, row);
}
function getCurrentPageKey(){
  // æ‰¾åˆ°ç›®å‰ display = block çš„ page
  const shown = [...document.querySelectorAll(".page")]
    .find(p => p.style.display !== "none");
  if(!shown) return "seg";
  return shown.id.replace("page-", ""); // seg / buy / view / bundle
}
function renderDbscanRadar(row) {
  const ctx = document.getElementById("kmeansRadar"); // âœ… å…±ç”¨åŒä¸€å¼µç•«å¸ƒ
  if (!ctx) return;

  const labels = ["R", "F", "M", "CAI"];
  const values = [
    row.avg_R_score ?? 0,
    row.avg_F_score ?? 0,
    row.avg_M_score ?? 0,
    row.avg_CAI_5 ?? 0
  ];

  if (insightRadarChart) {
    insightRadarChart.data.datasets[0].data = values;
    insightRadarChart.update();
    return;
  }

  insightRadarChart = new Chart(ctx, {
    type: "radar",
    data: {
      labels,
      datasets: [{
        label: "Avg Scores",
        data: values
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { r: { beginAtZero: true } }
    }
  });
}
/* ===== å•†å“çµ„åˆå„ªåŒ–ï¼ˆå¾ product_combination.xlsx è®€å– A~F æ¬„ï¼Œä¾ä¿¡å¿ƒåº¦æ’åºï¼‰ ===== */
let bundleRules = null;
let bundleLoaded = false;

function parseMetric(v){
  if (v === null || v === undefined) return null;
  if (typeof v === "number") return v;
  const s = String(v).trim();
  if (!s) return null;
  // æ”¯æ´ "12.3%" é€™ç¨®
  const pct = s.match(/^(-?\d+(\.\d+)?)\s*%$/);
  if (pct) return Number(pct[1]) / 100;
  // ä¸€èˆ¬æ•¸å­—ï¼ˆå«é€—è™Ÿï¼‰
  const num = s.replace(/,/g,"");
  const n = Number(num);
  return Number.isFinite(n) ? n : null;
}

async function loadBundleXlsxOnce(){
  if (bundleLoaded) return;
  bundleLoaded = true;

  try{
    const res = await fetch("product_combination.xlsx"); // âœ… èˆ‡ index.html åŒå±¤
    const buf = await res.arrayBuffer();
    const wb = XLSX.read(buf, { type:"array" });
    const sheetName = wb.SheetNames[0];
    const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], { defval: null });

    // åªä¿ç•™ A~Fï¼ˆå°æ‡‰æ¬„ä½åç¨±ï¼šå‰é …/å¾Œé …/æ”¯æŒåº¦/ä¿¡å¿ƒåº¦/æå‡åº¦/ç¢ºä¿¡åº¦ï¼‰
    bundleRules = rows.map(r => ({
      A: r["å‰é … (è²·äº† A)"] ?? r["å‰é …"] ?? null,
      B: r["å¾Œé … (è·Ÿè‘—è²· B)"] ?? r["å¾Œé …"] ?? null,
      confidence: parseMetric(r["ä¿¡å¿ƒåº¦"]),
      lift: parseMetric(r["æå‡åº¦ (Lift)"] ?? r["æå‡åº¦"]),
      conviction: parseMetric(r["ç¢ºä¿¡åº¦"])
    }))
    // éæ¿¾æ‰ç©ºåˆ—
    .filter(r => (r.A || r.B) && (r.confidence !== null));

    // ä¾ä¿¡å¿ƒåº¦æ’åï¼ˆé«˜â†’ä½ï¼‰ï¼›åŒåˆ†å†ä»¥ Lift æ’
    bundleRules.sort((x,y) => (y.confidence - x.confidence) || ((y.lift ?? -Infinity) - (x.lift ?? -Infinity)));

    renderBundleTable();
  }catch(err){
    console.error("loadBundleXlsxOnce failed:", err);
    document.getElementById("bundleHint").textContent = "âŒ è®€å– product_combination.xlsx å¤±æ•—ï¼šè«‹ç¢ºèªæª”æ¡ˆèˆ‡ index.html åŒå±¤ï¼Œä¸”å¯è¢« fetch å­˜å–ã€‚";
  }
}

function fmtMetric(v, digits=4){
  if (v === null || v === undefined || Number.isNaN(v)) return "â€”";
  // å°æ–¼ 1 çš„æŒ‡æ¨™å¤šåŠæ˜¯æ¯”ä¾‹ï¼šç”¨ 0.1234 è¡¨ç¤ºï¼›ä½ ä¹Ÿå¯æ”¹æˆç™¾åˆ†æ¯”é¡¯ç¤º
  return roundTo(Number(v), digits).toFixed(digits);
}

function renderBundleTable(){
  const hint = document.getElementById("bundleHint");
  const wrap = document.getElementById("bundleTableWrapper");
  const tbody = document.getElementById("bundleTableBody");
  const meta = document.getElementById("bundleMeta");
  const countEl = document.getElementById("bundleCount");

  if(!bundleRules || bundleRules.length === 0){
    hint.style.display = "block";
    wrap.style.display = "none";
    meta.style.display = "none";
    return;
  }

  hint.style.display = "none";
  wrap.style.display = "block";
  meta.style.display = "inline-flex";
  countEl.textContent = bundleRules.length;

  tbody.innerHTML = "";
  bundleRules.forEach((r, i) => {
    tbody.innerHTML += `
      <tr>
        <td>${i+1}</td>
        <td>${r.A ?? ""}</td>
        <td>${r.B ?? ""}</td>
        <td><b>${fmtMetric(r.confidence)}</b></td>
        <td>${fmtMetric(r.lift)}</td>
        <td>${fmtMetric(r.conviction)}</td>
      </tr>
    `;
  });
}
</script>

</body>
</html>

